<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inaccurate PP4 Data Statistics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            border-collapse: collapse;
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
        input, select, button {
            margin: 5px 0;
            padding: 4px 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<h1>Inaccurate PP4 Data Statistics</h1>

<h2>Top 10 General Playtime</h2>
<table id="topPlaytimeTable"><tbody></tbody></table>

<h2>Top 10 General Resets</h2>
<table id="topResetsTable"><tbody></tbody></table>

<h2>Search Player</h2>
<input list="playerNames" id="searchInput" placeholder="Enter player name">
<datalist id="playerNames"></datalist>
<button onclick="searchPlayer()">Search</button>
<div id="searchResult"></div>

<h2>Track Leaderboard</h2>
<select id="trackSelect" onchange="renderTrackLeaderboard()"></select>
<button onclick="toggleTrackLeaderboard()">Toggle Playtime / Resets</button>
<table id="trackLeaderboardTable"><tbody></tbody></table>

<script>
let data = null;
let userIdToName = {};
let trackLeaderboardMode = 'playtime'; // 'playtime' or 'resets'

// Mapping track IDs to names
const trackNames = {
    1: "Bonk III - The Last Act",
    2: "Primordial Soup",
    3: "Ters",
    4: "Tadpole",
    5: "WICKED Flip 2",
    6: "rest in beef",
    7: "Royalll",
    8: "FellowPurper=Stupid",
    9: "toWer",
    10: "Overwalls",
    11: "Desolate Road",
    12: "Float Like a Butterfly",
    13: "a leap of faith",
    14: "Drukkies",
    15: "Lost In The Deep",
    16: "2 Wheels, 2 Brain Cells",
    17: "Crashing out in style!",
    18: "Giraffirigian Kacky Edition",
    19: "Pain 4",
    20: "Skeeball Drop",
    21: "Oops I dropped the editor",
    22: "HasenhÃ¼pfer",
    23: "Exaltation",
    24: "City Slick",
    25: "spinny thingy"
};

function formatSeconds(seconds) {
    const d = Math.floor(seconds / 86400);
    seconds %= 86400;
    const h = Math.floor(seconds / 3600);
    seconds %= 3600;
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);

    let parts = [];
    if(d) parts.push(d + 'd');
    if(h) parts.push(h + 'h');
    if(m) parts.push(m + 'm');
    if(s || parts.length === 0) parts.push(s + 's');

    return parts.join(' ');
}

function buildUserIdToNameMap() {
    const map = {};
    for(const key of Object.keys(data)) {
        const arr = data[key];
        if(!Array.isArray(arr)) continue;
        arr.forEach(entry => {
            if(entry.userId && entry.name) {
                map[entry.userId] = entry.name;
            }
        });
    }
    return map;
}

function calculateTotals() {
    const fixed = {};
    for(const entry of data.player_stats) {
        const userId = entry.userId;
        const tracksObject = JSON.parse(entry.tracks);

        let totalPlaytime = 0;
        let totalResets = 0;
        for(const stats of Object.values(tracksObject)) {
            totalPlaytime += stats.playtime || 0;
            totalResets += stats.resets || 0;
        }

        fixed[userId] = {
            tracks: tracksObject,
            totalPlaytime,
            totalResets
        };
    }
    data.player_stats_fixed = fixed;
}

function populateAutocomplete() {
    const dataList = document.getElementById("playerNames");
    dataList.innerHTML = "";
    const uniqueNames = new Set(Object.values(userIdToName));
    uniqueNames.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        dataList.appendChild(option);
    });
}

function renderTop10() {
    const players = Object.entries(data.player_stats_fixed)
        .map(([userId, stats]) => ({
            name: userIdToName[userId] || userId,
            ...stats
        }));

    const topPlaytime = [...players].sort((a,b) => b.totalPlaytime - a.totalPlaytime).slice(0,10);
    const topResets   = [...players].sort((a,b) => b.totalResets - a.totalResets).slice(0,10);

    const playtimeTable = document.getElementById("topPlaytimeTable").querySelector("tbody");
    playtimeTable.innerHTML = "";
    topPlaytime.forEach((p,i) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${formatSeconds(p.totalPlaytime)}</td>`;
        playtimeTable.appendChild(row);
    });

    const resetsTable = document.getElementById("topResetsTable").querySelector("tbody");
    resetsTable.innerHTML = "";
    topResets.forEach((p,i) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.totalResets}</td>`;
        resetsTable.appendChild(row);
    });
}

function searchPlayer() {
    const name = document.getElementById("searchInput").value.trim();
    const resultDiv = document.getElementById("searchResult");
    resultDiv.innerHTML = "";

    const userId = Object.keys(userIdToName).find(id => userIdToName[id] === name);
    if(!userId) {
        resultDiv.textContent = "Player not found";
        return;
    }

    const stats = data.player_stats_fixed[userId];
    if(!stats) {
        resultDiv.textContent = "Player stats not found";
        return;
    }

    const table = document.createElement("table");
    const header = document.createElement("tr");
    header.innerHTML = "<th>Track</th><th>Playtime</th><th>Resets</th>";
    table.appendChild(header);

    for(const [trackId, trackStats] of Object.entries(stats.tracks)) {
        const trackNum = trackId.replace("track", "");
        const trackName = trackNames[trackNum] || trackId;
        const row = document.createElement("tr");
        row.innerHTML = `<td>${trackName}</td><td>${formatSeconds(trackStats.playtime)}</td><td>${trackStats.resets}</td>`;
        table.appendChild(row);
    }

    const totals = document.createElement("tr");
    totals.innerHTML = `<td><strong>Total</strong></td><td>${formatSeconds(stats.totalPlaytime)}</td><td>${stats.totalResets}</td>`;
    table.appendChild(totals);

    resultDiv.appendChild(table);
}

function renderTrackSelect() {
    const select = document.getElementById("trackSelect");
    select.innerHTML = "";
    for(let i=1;i<=25;i++) {
        const option = document.createElement("option");
        option.value = `track${i}`;
        option.textContent = trackNames[i] || `Track ${i}`;
        select.appendChild(option);
    }
}

function renderTrackLeaderboard() {
    const trackId = document.getElementById("trackSelect").value;

    let leaderboard = Object.entries(data.player_stats_fixed)
        .filter(([_, stats]) => stats.tracks[trackId])
        .map(([userId, stats]) => ({
            name: userIdToName[userId] || userId,
            track: stats.tracks[trackId]
        }));

    leaderboard.sort((a,b) => trackLeaderboardMode === 'playtime'
        ? b.track.playtime - a.track.playtime
        : b.track.resets - a.track.resets
    );

    const tableBody = document.getElementById("trackLeaderboardTable").querySelector("tbody");
    tableBody.innerHTML = "";
    leaderboard.slice(0,10).forEach((p,i) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${trackLeaderboardMode==='playtime'? formatSeconds(p.track.playtime) : p.track.resets}</td>`;
        tableBody.appendChild(row);
    });
}

function toggleTrackLeaderboard() {
    trackLeaderboardMode = trackLeaderboardMode === 'playtime' ? 'resets' : 'playtime';
    renderTrackLeaderboard();
}

// Load data
fetch('data.json')
    .then(res => res.json())
    .then(json => {
        data = json.data;
        userIdToName = buildUserIdToNameMap();
        calculateTotals();
        renderTop10();
        populateAutocomplete();
        renderTrackSelect();
        renderTrackLeaderboard();
    })
    .catch(err => console.error("Failed to load data.json", err));
</script>
</body>
</html>
