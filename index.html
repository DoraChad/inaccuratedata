<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inaccurate PP4 Data Statistics</title>
</head>
<body>
    <h1>Inaccurate PP4 Data Statistics</h1>

    <h2>Top 10 General Playtime</h2>
    <ul id="topPlaytime"></ul>

    <h2>Top 10 General Resets</h2>
    <ul id="topResets"></ul>

    <h2>Search Player</h2>
    <input list="playerNames" id="searchInput" placeholder="Enter player name">
    <datalist id="playerNames"></datalist>
    <button onclick="searchPlayer()">Search</button>
    <div id="searchResult"></div>

    <h2>Track Leaderboard</h2>
    <select id="trackSelect" onchange="renderTrackLeaderboard()"></select>
    <button onclick="toggleTrackLeaderboard()">Toggle Playtime / Resets</button>
    <ul id="trackLeaderboard"></ul>

<script>
let data = null;
let userIdToName = {};
let trackLeaderboardMode = 'playtime'; // 'playtime' or 'resets'

// Helper to format seconds
function formatSeconds(seconds) {
    const d = Math.floor(seconds / 86400);
    seconds %= 86400;
    const h = Math.floor(seconds / 3600);
    seconds %= 3600;
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);

    let parts = [];
    if (d) parts.push(d + 'd');
    if (h) parts.push(h + 'h');
    if (m) parts.push(m + 'm');
    if (s || parts.length === 0) parts.push(s + 's');

    return parts.join(' ');
}

// Build userId -> name map by scanning all arrays in data
function buildUserIdToNameMap() {
    const map = {};
    for (const key of Object.keys(data)) {
        const arr = data[key];
        if (!Array.isArray(arr)) continue;
        arr.forEach(entry => {
            if (entry.userId && entry.name) {
                map[entry.userId] = entry.name;
            }
        });
    }
    return map;
}

// Fix player_stats to parse tracks JSON and calculate totals
function calculateTotals() {
    const fixed = {};

    for (const entry of data.player_stats) {
        const userId = entry.userId;
        const tracksObject = JSON.parse(entry.tracks);

        let totalPlaytime = 0;
        let totalResets = 0;

        for (const stats of Object.values(tracksObject)) {
            totalPlaytime += stats.playtime || 0;
            totalResets += stats.resets || 0;
        }

        fixed[userId] = {
            tracks: tracksObject,
            totalPlaytime,
            totalResets
        };
    }

    data.player_stats_fixed = fixed;
}

// Populate autocomplete for player search
function populateAutocomplete() {
    const dataList = document.getElementById("playerNames");
    dataList.innerHTML = "";
    const uniqueNames = new Set(Object.values(userIdToName));
    uniqueNames.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        dataList.appendChild(option);
    });
}

// Render top 10 lists
function renderTop10() {
    const players = Object.entries(data.player_stats_fixed)
        .map(([userId, stats]) => ({
            name: userIdToName[userId] || userId,
            ...stats
        }));

    const topPlaytime = [...players].sort((a,b) => b.totalPlaytime - a.totalPlaytime).slice(0,10);
    const topResets   = [...players].sort((a,b) => b.totalResets - a.totalResets).slice(0,10);

    const playtimeList = document.getElementById("topPlaytime");
    playtimeList.innerHTML = "";
    topPlaytime.forEach(p => {
        let li = document.createElement("li");
        li.textContent = `${p.name} - ${formatSeconds(p.totalPlaytime)}`;
        playtimeList.appendChild(li);
    });

    const resetsList = document.getElementById("topResets");
    resetsList.innerHTML = "";
    topResets.forEach(p => {
        let li = document.createElement("li");
        li.textContent = `${p.name} - ${p.totalResets} resets`;
        resetsList.appendChild(li);
    });
}

// Search player by name
function searchPlayer() {
    const name = document.getElementById("searchInput").value.trim();
    const resultDiv = document.getElementById("searchResult");
    resultDiv.innerHTML = "";

    const userId = Object.keys(userIdToName).find(id => userIdToName[id] === name);
    if (!userId) {
        resultDiv.textContent = "Player not found";
        return;
    }

    const stats = data.player_stats_fixed[userId];
    if (!stats) {
        resultDiv.textContent = "Player stats not found";
        return;
    }

    const table = document.createElement("table");
    const header = document.createElement("tr");
    header.innerHTML = "<th>Track</th><th>Playtime</th><th>Resets</th>";
    table.appendChild(header);

    for (const [track, trackStats] of Object.entries(stats.tracks)) {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${track}</td><td>${formatSeconds(trackStats.playtime)}</td><td>${trackStats.resets}</td>`;
        table.appendChild(row);
    }

    const totals = document.createElement("tr");
    totals.innerHTML = `<td><strong>Total</strong></td><td>${formatSeconds(stats.totalPlaytime)}</td><td>${stats.totalResets}</td>`;
    table.appendChild(totals);

    resultDiv.appendChild(table);
}

// Track selection dropdown
function renderTrackSelect() {
    const select = document.getElementById("trackSelect");
    select.innerHTML = "";
    for (let i = 1; i <= 25; i++) {
        const option = document.createElement("option");
        option.value = `track${i}`;
        option.textContent = `Track ${i}`;
        select.appendChild(option);
    }
}

// Track leaderboard rendering
function renderTrackLeaderboard() {
    const trackId = document.getElementById("trackSelect").value;

    let leaderboard = Object.entries(data.player_stats_fixed)
        .filter(([_, stats]) => stats.tracks[trackId])
        .map(([userId, stats]) => ({
            name: userIdToName[userId] || userId,
            track: stats.tracks[trackId]
        }));

    leaderboard.sort((a,b) => {
        return trackLeaderboardMode === 'playtime'
            ? b.track.playtime - a.track.playtime
            : b.track.resets - a.track.resets;
    });

    const list = document.getElementById("trackLeaderboard");
    list.innerHTML = "";
    leaderboard.slice(0,10).forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name} - ${
            trackLeaderboardMode === 'playtime'
            ? formatSeconds(p.track.playtime)
            : p.track.resets + " resets"
        }`;
        list.appendChild(li);
    });
}

function toggleTrackLeaderboard() {
    trackLeaderboardMode = trackLeaderboardMode === 'playtime' ? 'resets' : 'playtime';
    renderTrackLeaderboard();
}

// Load data.json
fetch('data.json')
    .then(res => res.json())
    .then(json => {
        data = json.data;
        userIdToName = buildUserIdToNameMap();
        calculateTotals();
        renderTop10();
        populateAutocomplete();
        renderTrackSelect();
        renderTrackLeaderboard();
    })
    .catch(err => console.error("Failed to load data.json", err));

</script>
</body>
</html>
